GUIA COMPLETA DEL PROYECTO CORONAHUB
====================================

Fecha de analisis: 2026-02-19
Ruta analizada: c:\Users\DAW2\desktop\CoronaHUB


1) RESUMEN EJECUTIVO
--------------------

CoronaHUB es un monorepo con:

- Frontend principal en React + Vite dentro de `client/`.
- Backend API en Node.js + Express dentro de `server/`.
- Un frontend legado en la raiz (`src/` + varios `.html`) que parece una version anterior.

Flujo principal:

1. Usuario navega frontend (`http://localhost:5173`).
2. Frontend consume API backend (`http://localhost:4000/api/...`).
3. Backend persiste datos en MongoDB o en archivo JSON (segun `DB_MODE`).
4. Admin modera opiniones y reservas desde `/admin/dashboard`.


2) ESTRUCTURA GENERAL DEL REPO
------------------------------

Carpetas y archivos principales:

- `package.json` (raiz)
  Orquesta client y server con `concurrently`.

- `client/`
  App React actual en produccion/desarrollo del frontend.

- `server/`
  API REST, validaciones, auth admin y capa de datos.

- `src/` (raiz)
  Codigo legado de una app React/Vite anterior (multipagina en HTML).
  No es el frontend que se levanta con `npm run dev` del monorepo.

- `README.md`, `SETUP.md`
  Guia de arranque y configuracion.

- `server/data/db.json`
  Base de datos local cuando `DB_MODE=file` o fallback de `auto`.


3) COMO ARRANCA TODO
--------------------

Archivo: `package.json` (raiz)

Scripts:

- `npm run install:all`
  Instala dependencias de `client` y `server`.

- `npm run dev`
  Ejecuta en paralelo:
  - `npm run dev:client` -> `client` (Vite)
  - `npm run dev:server` -> `server` (Node)

Puertos:

- Frontend: `http://localhost:5173`
- Backend: `http://localhost:4000`


4) FRONTEND ACTUAL (client/)
----------------------------

4.1 Boot y routing

- `client/src/main.jsx`
  Punto de entrada. Renderiza `App`.

- `client/src/App.jsx`
  Contenedor minimo; delega en `AppRouter`.

- `client/src/router.jsx`
  Define rutas:
  - `/` -> Home
  - `/carta` -> Carta
  - `/eventos` -> Eventos
  - `/galeria` -> Galeria
  - `/contact` -> Opiniones
  - `/reservation` -> Reservas
  - `/admin/login` -> Login admin
  - `/admin/dashboard` -> Dashboard protegido por token
  - `*` -> redirect a `/`

Proteccion admin:
- `ProtectedRoute` verifica `localStorage.getItem("coronahub_token")`.


4.2 Capa API del frontend

- `client/src/services/api.js`
  Wrapper central de fetch:
  - `baseUrl = VITE_API_URL || "http://localhost:4000"`
  - Adjunta `Authorization: Bearer <token>` si existe token.
  - Parsea JSON y unifica errores (HTTP y `ok:false`).

Servicios por dominio:

- `client/src/services/auth.service.js`
  Login admin y gestion de token.

- `client/src/services/reviews.service.js`
  Crear opinion, listar aprobadas y operaciones admin de opiniones.

- `client/src/services/reservations.service.js`
  Crear reserva, consultar disponibilidad, operaciones admin de reservas.

- `client/src/services/menu.service.js`
  Leer/editar menu desde admin.

- `client/src/services/events.service.js`
  Leer/editar eventos.


4.3 Paginas publicas

- `client/src/pages/Home.jsx`
  Home principal.
  - Carga eventos desde API (`getEvents`).
  - Si falla API, usa fallback local (`eventsFallback`).
  - Muestra portada, eventos y enlace a mapa Google.

- `client/src/pages/Carta.jsx`
  Muestra menu diario y platos combinados.
  - Tiene fallback local (`fallbackMenu` en el mismo archivo).
  - Consulta `GET /api/menu`.

- `client/src/pages/Eventos.jsx`
  Muestra eventos en formato bloques.
  - Carga desde API (`GET /api/events`) con fallback local.
  - Resuelve imagenes con `resolveEventImage`.

- `client/src/pages/Galeria.jsx`
  Galeria estatica de imagenes de Cloudinary.

- `client/src/pages/Contact.jsx`
  Sistema de opiniones:
  - Formulario de envio (`POST /api/reviews`) con estrellas 1-5.
  - Lista opiniones aprobadas (`GET /api/reviews`).
  - Mensajes de feedback con `FormFeedback`.
  Nota: actualmente no hay consumo de reseñas de Google en esta version.

- `client/src/pages/Reservation.jsx`
  Reserva de mesas:
  - Consulta disponibilidad por fecha (`GET /api/reservations/availability?date=...`).
  - Bloquea seleccion de mesas ocupadas para la hora elegida.
  - Envia reserva (`POST /api/reservations`).
  - Refresca disponibilidad tras reservar.
  - Incluye validaciones de UI (campos requeridos para habilitar boton).


4.4 Admin frontend

- `client/src/pages/admin/Login.jsx`
  Login de admin; guarda JWT en localStorage.

- `client/src/pages/admin/Dashboard.jsx`
  Panel principal admin:
  - Moderacion de opiniones pendientes.
  - Moderacion de reservas pendientes.
  - Vista de proximas reservas.
  - Editor de carta (banner, dias, combinados).
  - Editor de eventos (homeCards, pageItems, fotos).
  - Guardado por API (`PUT /api/admin/menu`, `PUT /api/admin/events`).


4.5 Componentes reutilizables

- `client/src/components/Navbar.jsx`
  Navbar responsive con menu hamburguesa y links React Router.

- `client/src/components/Footer.jsx` y `FooterSmall.jsx`
  Pies de pagina con contacto.

- `client/src/components/ImageStack.jsx`
  Renderiza lista de imagenes en el tag indicado.

- `client/src/components/FormFeedback.jsx`
  Renderiza `error` y `status` de formularios.


4.6 Recursos visuales

- `client/src/constants/cloudinaryAssets.js`
  URLs de imagenes alojadas en Cloudinary.

- `client/src/constants/eventsFallback.js`
  Datos de eventos por defecto y mapeo de fotos fallback.

- CSS por pagina:
  - `App.css`, `carta.css`, `eventos.css`, `galeria.css`,
    `opiniones.css`, `reserva.css`, `index.css`, `styles/*`.


5) BACKEND (server/)
--------------------

5.1 Entrada del servidor

- `server/src/index.js`
  - Carga `.env`.
  - Configura seguridad basica (`helmet`), CORS y JSON parser.
  - Define healthcheck: `GET /api/health`.
  - Monta routers:
    - `/api/reviews`
    - `/api/reservations`
    - `/api/menu`
    - `/api/events`
    - `/api/admin`
  - Middleware de error global (500).


5.2 Capa de datos

- `server/src/db.js`
  Es la pieza mas importante del backend.

Responsabilidades:

1. Seleccion de modo de almacenamiento:
   - `DB_MODE=mongo`
   - `DB_MODE=file`
   - `DB_MODE=auto` (intenta mongo y cae a archivo si falla)

2. Persistencia:
   - MongoDB (`reviews`, `reservations`, `settings`)
   - O archivo JSON `server/data/db.json`

3. Funciones de dominio:
   - Opiniones:
     - `listApprovedReviews`
     - `listAllReviews`
     - `createReview`
     - `updateReviewStatus`
   - Reservas:
     - `listAllReservations`
     - `createReservation`
     - `updateReservationStatus`
     - `listActiveReservationsByDate`
   - Menu/eventos:
     - `getMenu` / `setMenu`
     - `getEvents` / `setEvents`

4. Logica de conflictos de reservas:
   - Evita doble reserva en misma fecha/hora/mesa para estados activos.
   - Estados activos: `PENDING`, `CONFIRMED`.

5. Defaults:
   - Usa `menu.default.js` y `events.default.js` cuando no hay datos.


5.3 Rutas API publicas

- `server/src/routes/reviews.routes.js`
  - `GET /api/reviews` -> solo opiniones `APPROVED`.
  - `POST /api/reviews` -> crea opinion `PENDING`.
  - Rate limit aplicado.
  - Valida payload con Zod (`review.schema.js`).
  - Guarda hash de IP y user-agent.

- `server/src/routes/reservations.routes.js`
  - `GET /api/reservations/availability?date=YYYY-MM-DD`
  - `POST /api/reservations` (estado inicial `PENDING`)
  - Rate limit aplicado.
  - Valida payload con Zod (`reservation.schema.js`).
  - Controla conflicto de mesa/horario (409).

- `server/src/routes/menu.routes.js`
  - `GET /api/menu`

- `server/src/routes/events.routes.js`
  - `GET /api/events`


5.4 Rutas API admin

- `server/src/routes/admin.routes.js`
  1) `POST /api/admin/login`
     - Valida email/password.
     - Compara contra `ADMIN_EMAIL` y `ADMIN_PASSWORD` del `.env`.
     - Devuelve JWT (2h).

  2) Middleware `authMiddleware` para el resto de rutas admin.

  3) Endpoints protegidos:
     - `GET /api/admin/menu`
     - `PUT /api/admin/menu`
     - `GET /api/admin/events`
     - `PUT /api/admin/events`
     - `GET /api/admin/reviews`
     - `PATCH /api/admin/reviews/:id`
     - `GET /api/admin/reservations`
     - `PATCH /api/admin/reservations/:id`

  4) Validaciones de payload con esquemas Zod internos.


5.5 Middlewares y utilidades

- `server/src/middlewares/auth.js`
  Verifica `Bearer token` con `JWT_SECRET`.

- `server/src/middlewares/rateLimit.js`
  Wrapper de `express-rate-limit`.

- `server/src/utils/hash.js`
  Hash SHA-256 de IP + `IP_HASH_SALT`.

- `server/src/validators/review.schema.js`
  - Nombre 2-50
  - Rating 1-5
  - Comentario 20-500

- `server/src/validators/reservation.schema.js`
  - Campos de reserva y formato fecha/hora
  - Regla de fecha/hora futura


6) MODELO FUNCIONAL (QUE HACE CADA MODULO)
------------------------------------------

6.1 Modulo opiniones

Flujo usuario:
- Form en `/contact` -> `POST /api/reviews`.
- Backend guarda en `PENDING`.
- No aparece en publico hasta aprobar.

Flujo admin:
- Dashboard carga `GET /api/admin/reviews`.
- Admin aprueba/rechaza via `PATCH`.
- Si aprueba, aparece en `/api/reviews` y en frontend publico.


6.2 Modulo reservas

Flujo usuario:
- Front pide disponibilidad por fecha.
- UI pinta mesas reservadas para la hora seleccionada.
- Usuario envia reserva.
- Backend valida y evita conflictos.

Flujo admin:
- Ve reservas pendientes/proximas.
- Cambia estado a `CONFIRMED` o `CANCELLED`.


6.3 Modulo carta

Publico:
- `GET /api/menu`, con fallback local en frontend.

Admin:
- Edita y guarda carta completa.
- Backend valida estructura y persiste.


6.4 Modulo eventos

Publico:
- Home y pagina de eventos consumen `GET /api/events`.
- Si no hay API, frontend usa fallback local.

Admin:
- Edita textos, horarios, imagenes y alt text.
- Guarda en backend con validacion.


7) VARIABLES DE ENTORNO (server/.env)
-------------------------------------

Variables clave:

- `PORT`
- `CORS_ORIGIN`
- `DB_MODE` (`auto|mongo|file`)
- `JWT_SECRET`
- `ADMIN_EMAIL`
- `ADMIN_PASSWORD`
- `IP_HASH_SALT`
- `MONGODB_URI`
- `MONGODB_DB`

Importante:
- Si faltan credenciales admin o jwt secret, el login/admin falla.
- Si Mongo falla y `DB_MODE=auto`, se usa `server/data/db.json`.
- Si `DB_MODE=mongo`, no hay fallback a archivo.


8) SEGURIDAD Y CALIDAD ACTUAL
-----------------------------

Fortalezas:
- Validacion de entrada con Zod.
- JWT para rutas admin.
- Helmet + CORS configurables.
- Rate limit en endpoints sensibles.
- Hash de IP en opiniones/reservas.

Puntos a vigilar:
- Credenciales admin en texto plano (comparacion directa contra `.env`).
- No hay suite de tests automatizados.
- No hay migraciones formales de datos.
- Token se guarda en localStorage (riesgo XSS si hubiera vulnerabilidades).


9) CODIGO LEGADO EN RAIZ (src/ + html)
--------------------------------------

Hay una segunda app en la raiz:

- `vite.config.js` de la raiz define build multipagina (`index.html`, `carta.html`, etc).
- `src/` raiz contiene versiones antiguas de componentes/paginas.
- Algunas inconsistencias:
  - `src/services/api.js` esta vacio.
  - nombre de archivo `Footer.Jsx` con mayuscula rara.
  - archivo suelto `src/page`.

Recomendacion:
- Mantener solo `client/` + `server/` como version viva.
- Archivar o limpiar `src/` y html legacy para evitar confusiones.


10) FLUJOS DE DATOS END-TO-END
------------------------------

10.1 Opinion nueva

1. Usuario envia formulario (`/contact`).
2. `createReview(payload)` llama `POST /api/reviews`.
3. Backend valida y guarda `PENDING`.
4. Admin aprueba en dashboard.
5. Opinion aparece en listado publico.

10.2 Reserva nueva

1. Usuario selecciona fecha/hora/mesa.
2. Front consulta disponibilidad.
3. Front envia `POST /api/reservations`.
4. Backend valida y detecta conflictos.
5. Reserva queda `PENDING`.
6. Admin confirma/cancela.

10.3 Edicion de carta/eventos

1. Admin abre dashboard.
2. Dashboard carga menu+eventos actuales.
3. Admin modifica formulario.
4. Dashboard envia `PUT` a rutas admin.
5. Publico ve cambios en siguiente carga.


11) GUIA RAPIDA PARA DESARROLLAR
--------------------------------

Para cambiar una pantalla publica:
- Editar en `client/src/pages/...`
- Ajustar estilos en su css correspondiente.

Para cambiar navegacion:
- `client/src/router.jsx`
- `client/src/components/Navbar.jsx`

Para agregar endpoint nuevo:
- Crear ruta en `server/src/routes/...`
- Conectarla en `server/src/index.js`
- Si usa datos persistentes, agregar funcion en `server/src/db.js`
- Crear servicio frontend en `client/src/services/...`

Para agregar validaciones:
- Usar Zod en `server/src/validators` o en ruta admin correspondiente.


12) RIESGOS TECNICOS Y RECOMENDACIONES PRIORITARIAS
---------------------------------------------------

Prioridad alta:
1. Mover `ADMIN_PASSWORD` a hash (bcrypt/argon2) o al menos secret manager.
2. Añadir tests basicos API (reviews/reservas/admin auth).
3. Unificar repo eliminando codigo legado de raiz.

Prioridad media:
1. Centralizar todos los fetch en servicios (Carta hoy usa fetch directo).
2. Añadir logs estructurados en backend.
3. Definir tipos/esquemas compartidos frontend-backend.

Prioridad baja:
1. Mejorar i18n/encoding de algunos textos (hay caracteres raros en salida).
2. Estandarizar nombres de archivos y convenciones.


13) CHECKLIST DE SALUD DEL PROYECTO
-----------------------------------

Cuando algo "no va":

1. Verificar que corren client y server.
2. Comprobar `http://localhost:4000/api/health`.
3. Revisar `server/.env`.
4. Confirmar CORS_ORIGIN = frontend actual.
5. Validar DB_MODE y estado MongoDB.
6. Revisar consola del navegador (errores de red/token).
7. Revisar logs backend (validaciones y 409 de reservas).


14) CONCLUSION
--------------

El proyecto tiene una base funcional y bien separada por dominios:
- Web publica
- Reservas y opiniones con moderacion
- Panel admin completo
- Persistencia flexible (mongo/file)

El mayor punto de mantenimiento ahora no es funcional, sino estructural:
conviven dos frontends (uno vigente en `client/` y otro legado en raiz).
Si limpias ese legado y agregas tests minimos, el proyecto queda mucho mas
estable para evolucionar.

